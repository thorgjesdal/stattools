#!/usr/bin/python
# -*- coding: utf-8 -*-
import sys
import requests
from bs4 import BeautifulSoup
import datetime
import openpyxl

def get_stats(event,cat,year, season, maxdepth):
    print(event,cat,year, season, maxdepth)
    event_id = {'MS':{'60' : '2', '100':'4', '200': '5', '400':'7', '800':'9', '1500':'11', '3000':'13', '5000':'14', '10000':'15', '60H' : '24', '110H':'42', '400H':'59', '3000SC' : '121', 'HJ':'68', 'PV':'70', 'LJ':'71', 'TJ':'75', 'SP' : '86', 'DT' : '93', 'HT' : '106', 'JT' : '98'},
                'MU23':{'60' : '2','100':'4', '200': '5', '400':'7', '800':'9', '1500':'11', '3000':'13', '5000':'14', '10000':'15', '60H' : '24', '110H':'42', '400H':'59', '3000SC' : '121', 'HJ':'68', 'PV':'70', 'LJ':'71', 'TJ':'75', 'SP' : '86', 'DT' : '93', 'HT' : '106', 'JT' : '98'},
                'MU20':{'60' : '2','100':'4', '200': '5', '400':'7', '800':'9', '1500':'11', '3000':'13', '5000':'14', '60H' : '23', '110H':'41', '400H':'59', '3000SC' : '121', 'HJ':'68', 'PV':'70', 'LJ':'71', 'TJ':'75', 'SP' : '85', 'DT' : '92', 'HT' : '105', 'JT' : '98'},
                'GU18':{'60' : '2','100':'4', '200': '5', '400':'7', '800':'9', '1500':'11', '3000':'13', '60H' : '22', '110H':'40', '400H':'58', '2000SC' : '275', 'HJ':'68', 'PV':'70', 'LJ':'71', 'TJ':'75', 'SP' : '84', 'DT' : '91', 'HT' : '104', 'JT' : '97'},
                'KS':{'60' : '2','100':'4', '200': '5', '400':'7', '800':'9', '1500':'11', '3000':'13', '5000':'14', '10000':'15', '60H' : '21', '100H':'35', '400H':'57', '3000SC' : '120',  'HJ':'68', 'PV':'70', 'LJ':'71', 'TJ':'75', 'SP' : '83', 'DT' : '90', 'HT' : '103', 'JT' : '96'}, 
                'KU23':{'60' : '2','100':'4', '200': '5', '400':'7', '800':'9', '1500':'11', '3000':'13', '5000':'14', '10000':'15', '60H' : '21', '100H':'35', '400H':'57', '3000SC' : '120',  'HJ':'68', 'PV':'70', 'LJ':'71', 'TJ':'75', 'SP' : '83', 'DT' : '90', 'HT' : '103', 'JT' : '96'},
                'KU20':{'60' : '2','100':'4', '200': '5', '400':'7', '800':'9', '1500':'11', '3000':'13', '5000':'14', '60H' : '21', '100H':'35', '400H':'57', '3000SC' : '120',  'HJ':'68', 'PV':'70', 'LJ':'71', 'TJ':'75', 'SP' : '83', 'DT' : '90', 'HT' : '103', 'JT' : '96'},
                'JU18':{'60' : '2','100':'4', '200': '5', '400':'7', '800':'9', '1500':'11', '3000':'13', '60H' : '20', '100H':'34', '400H':'57', '2000SC' : '65',  'HJ':'68', 'PV':'70', 'LJ':'71', 'TJ':'75', 'SP' : '82', 'DT' : '90', 'HT' : '155', 'JT' : '139'} } 
    catcodes = {'KS': '235', 'KU23' : '236', 'KU20' : '237', 'JU18' : '238',
                'MS': '231', 'MU23' : '232', 'MU20' : '233', 'GU18' : '234'}

    ute = {'indoor' : 'N', 'outdoor' : 'Y'}
    print(cat, event)
    if event in event_id[cat].keys():
       url = 'https://www.minfriidrettsstatistikk.info/php/WA-Reporting.php?showclass=' + catcodes[cat] + '&showevent=' + event_id[cat][event] + '&outdoor='+ute[season]+'&showseason=' + year + '&showclub=0'
       print(url)
       r = requests.get(url)

    
       soup = BeautifulSoup(r.text, 'html.parser')
       tables = [
           [
               [td.get_text(strip=True) for td in tr.find_all('td')]
               for tr in table.find_all('tr')
           ]
           for table in soup.find_all('table')
       ] 
   
       stats = []
       print(len(tables[0]),maxdepth)
       depth = min(len(tables[0]),maxdepth)
       print(depth)
       for row in tables[0][0:depth]:
           #for row in table:
           if not row == [] and not row[0] == '-----':
              stats.append(row)
       return stats

cats = ['MS', 'MU23', 'MU20', 'GU18',
        'KS', 'KU23', 'KU20', 'JU18']
cat_en = {'MS' : 'SM', 'MU23' : 'U23M', 'MU20' : 'U20M', 'GU18' : 'U18B',
          'KS' : 'SW', 'KU23' : 'U23W', 'KU20' : 'U20W', 'JU18' : 'U18G'}
"""
cat_events = {'MS'   : ['100', '200', '400','800', '1500', '3000', '5000', '10000', '110H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'MU23' : ['100', '200', '400','800', '1500', '3000', '5000', '10000', '110H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'MU20' : ['100', '200', '400','800', '1500', '3000', '5000', '110H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'GU18' : ['100', '200', '400','800', '1500', '3000', '110H', '400H', '2000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'KS'   : ['100', '200', '400','800', '1500', '3000', '5000', '10000', '100H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'KU23' : ['100', '200', '400','800', '1500', '3000', '5000', '10000', '100H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'KU20' : ['100', '200', '400','800', '1500', '3000', '5000', '100H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'JU18' : ['100', '200', '400','800', '1500', '3000', '100H', '400H', '2000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ]
}
"""
cat_events = {'outdoor' :
              {'MS'   : ['100', '200', '400','800', '1500', '3000', '5000', '10000', '110H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'MU23' : ['100', '200', '400','800', '1500', '3000', '5000', '10000', '110H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'MU20' : ['100', '200', '400','800', '1500', '3000', '5000', '110H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'GU18' : ['100', '200', '400','800', '1500', '3000', '110H', '400H', '2000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'KS'   : ['100', '200', '400','800', '1500', '3000', '5000', '10000', '100H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'KU23' : ['100', '200', '400','800', '1500', '3000', '5000', '10000', '100H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'KU20' : ['100', '200', '400','800', '1500', '3000', '5000', '100H', '400H', '3000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ],
              'JU18' : ['100', '200', '400','800', '1500', '3000', '100H', '400H', '2000SC', 'HJ', 'PV', 'LJ', 'TJ', 'SP', 'DT', 'HT', 'JT' ]
              },
'indoor' : 
         {'MS'   : ['60', '200', '400','800', '1500', '3000', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP'],
          'MU23' : ['60', '200', '400','800', '1500', '3000', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP'],
          'MU20' : ['60', '200', '400','800', '1500', '3000', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP'],
          'GU18' : ['60', '200', '400','800', '1500', '3000', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP'],
          'KS'   : ['60', '200', '400','800', '1500', '3000', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP'],
          #'KU23' : ['60', '200', '400','800', '1500', '3000', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP'],
          'KU23' : ['60', '200', '400','800', '1500', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP'],
          #'KU20' : ['60', '200', '400','800', '1500', '3000', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP'],
          'KU20' : ['60', '200', '400','800', '1500', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP'],
          #'JU18' : ['60', '200', '400','800', '1500', '3000', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP']
          'JU18' : ['60', '200', '400','800', '1500', '60H', 'HJ', 'PV', 'LJ', 'TJ', 'SP']
        }  }
year = '2021'
seasons =  ['outdoor', 'indoor']
cat_maxdepth = {'MS' : 100, 'MU23' : 50, 'MU20' : 35, 'GU18' : 25,
                'KS' : 100, 'KU23' : 50, 'KU20' : 35, 'JU18' : 25}

for season in seasons:
    for cat in cats:
        outfilename = '_'.join(['NOR', cat_en[cat],year,season])+'.xlsx'
        csv = ""
        workbook = openpyxl.Workbook()
        sheet=workbook.active
        for event in cat_events[season][cat]:
            s = get_stats(event,cat,year, season, cat_maxdepth[cat])
            catevent = [' '.join([cat_en[cat], event])]
            if season == 'indoor':
                catevent[0] += ' indoor'
                print(season, catevent)
            sheet.append(catevent)
            for row in s:
                sheet.append(row)
        workbook.save(outfilename)
        workbook.close()
